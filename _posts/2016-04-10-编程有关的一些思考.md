---
layout: post
description: "None.NULL"
tweet-text: ""
author: taocp
tags:
- programming
categories:
- ""
---

今天下午编程时遇到一个“难题”，百思不得其解。经过前辈指点，才恍然大悟。
回想过去的几年，虽然写的代码不多，但类似的情形遇到过好几回！

我想，应该将这些问题分门别类，其实很多问题都可以抽象出一个（或多个）相似的“模式”，
解决这类问题有一个共通的方法。
可以多回顾曾经遇到的问题及其对应的解决方案，总结经验教训。

---

# 用户

确保程序、用户能够精确地互相理解，避免歧义、误解引发错误。

### 给用户精确控制程序的机会

可以人性化一些，尝试为用户做更多的事情，尽管用户没有明确要求。
但一定要考虑用户不需要程序“自作多情”时，能够非常轻易、自然地取消掉这些多余的行为。

例如Python2的`print`默认添加newline或者空格，在大部分场景下是ok的，但部分场景下用户并不需要这个特性，
坑爹的是想避免这样还比较麻烦，要么得加个奇怪的逗号，要么调用其它方法来实现。
还好Python3的`print()`支持设置end参数（不过某些技术被锁死在GCC3和Python2时代的公司，并不能享受到这个福利）

### 如果用户指定的方式不work，则应该明确告知用户

用户指定了条件A，执行时发现A并不work，程序可以尝试从错误中恢复，但必须确保用户清楚发生了什么，
不能在A失败的情况下默默替用户选择B.

曾经遇到这么一个问题：有个程序启动时会读取配置文件，用户可以在init时通过函数参数指定配置文件路径，
如果指定的文件不存在就依次寻找几个预设位置的配置文件。
有一天，用户x通过函数参数指定了配置文件"/path/to/conf.flag"，然而这个路径有误，
程序找不到该文件，于是就在默认路径上找到一个conf文件用了起来（恰巧默认路径上有一个不当的配置文件），结果可想而知。
更好的方法应当是：程序发现用户指定了一个有误的参数，告知用户（返回错误），而不是自作主张。


### 如果做一件事有多种方法，则应当避免歧义

假设一个程序需要读取的配置文件可以由以下途径得到：

- 环境变量
- API参数指定
- 默认位置1
- 默认位置2
- 默认位置...
- 默认位置x

随着用户、运维人员的更迭，可能的局面是“环境变量”、“API参数”、数个“默认位置”都对应这一个配置文件。
当一个新用户面临这种情景，想要弄清当前正在work的是哪个配置文件可能并不容易。

个人感觉最好不要有默认查找行为，“环境变量”高优，API参数次优。
这个规则简单易记，符合convention，环境变量高优也有利于临时调试程序。
当然，如果“环境变量”不是必需，只通过API指定是最好的。

### 知晓所依赖的系统并不完善

使用外部系统时，应当知晓必有其不完善之处，
除非确有必要，尽量避免不成熟、不稳定的feature，
面临特殊场景时，考虑到自己的用法可能触发其bug.

一个支持KV的存储系统T，用户在存数据时存入了一些size巨大的key（具体多大用户自己也不知道！），
系统T默默截断了key至64KB并告知用户存储ok，当用户试图用原始key（size巨大）去读时发现数据读不到。

这样一个事故，存储系统T负有全部责任。
但如果用户考虑得更加周全一些，了解自己的特殊场景并提前和系统T的研发人员沟通，
就可以免去很多本可以不需要的debug开销了。
毕竟类比一下，Linux支持的path最大值默认也就4096 Bytes.

---

# 理解现有代码遇到问题

应该先确保正确理解现代码所用的api、工具等

如果是很陌生的api，可能还会仔细查阅手册，减少出错的概率；
但如果看到一个api似乎马上就能理解其意思，但实际行为和用户所理解的不一致，则会导致问题。

遇到过这类问题好几次，我的看法是：

一方面，用户/代码阅读者应该谨慎，如果相应代码表现出异常，则更应该仔细阅读文档；
另一方面，api/代码coder应该保持良好的设计，不要“让用户惊讶”，尽力避免ta人的误解。

---

# 新技术、新知识

在用新(陌生)技术解决问题、实际应用之前，应当对新东西有一个宏观的、整体的认识。

如果有好的tutorial，不妨跟着做一做，会有更直观的理解；
如果有自动生成的代码，也要弄清生成的代码（模块、文件）的作用，如果可以大致看看代码是怎样的。


---

# 一些有趣的特性

### 运行时reload config

对于很多需要7 x 24运行的服务来说，能够支持在运行时更新配置文件是一个很必须的功能；
特别是有些问题（例如bug）在程序重启后可能不再复现，如果此时支持运行时reload config，
可能有益于发现问题（例如调整日志打印级别，更改特定参数等）。

程序设计时就要考虑到动态地reload config，具体问题具体分析吧。

见过有程序把一些属性放在某个特定namespace里，然后gdb上去直接改内存的。
