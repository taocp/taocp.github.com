---
layout: post
description: "None.NULL"
tweet-text: ""
author: taocp
tags:
- programming
categories:
- ""
---


平时工作学习，常常遇到一些“小问题”，有很多办法可以绕开或者“解决”，有空的时候稍微深入查阅资料了解其中的原因也蛮有意思。


1. 假设可执行程序`a.out`使用了`x.so`，在`a.out`运行时，`cp a.out.new a.out`会报`Text file busy`，
`cp x.v2.so x.so`可能导致进程crash，在替换可执行文件或者动态库时，如果是先`rm`再`cp`（而不是直接`cp`覆盖）又都是ok的，为什么？

  - `rm`后再`cp`是删除旧文件（Linux保证已经打开旧文件的进程仍然能看到旧文件，这些进程都关闭旧文件时发生真正的删除）再写一个新文件（inode变了），`cp src des`是在原文件上写入新内容（inode没变）。
  - 运行时`cp a.out.new a.out`是尝试打开`a.out`写入`a.out.new`的内容，`open()`的时候Linux检测到这个二进制程序正在运行，所以返回`ETXTBSY(Text file busy)`错误。
  - 运行时`cp x.v2.so x.so`是尝试打开`x.so`写入`x.v2.so`的内容，但（截至目前2017.11）并没有针对so的“写保护”，所以覆盖写操作本身ok，不过so一般都是`mmap`到内存的，可能不是整个so文件都已在内存（按需），
    如果运行过程中替换了so，下次再访问so内容时按照旧so的各种偏移来访问新so文件就会crash.
  - [ref1](https://unix.stackexchange.com/a/74172/73846), [ref2](https://stackoverflow.com/a/7779703/1498303)
